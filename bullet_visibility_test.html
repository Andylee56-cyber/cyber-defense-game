<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>子弹可见性和知识库功能测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #0a0a2a;
            font-family: Arial, sans-serif;
            color: #ffffff;
        }
        
        .test-section {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #00ffff;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
        }
        
        .info {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
        }
        
        .warning {
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid #ffa500;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
        }
        
        .mock-game {
            position: relative;
            width: 600px;
            height: 400px;
            background: linear-gradient(to right, rgba(0, 20, 40, 0.8), rgba(30, 15, 60, 0.8));
            border: 2px solid #00ffff;
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .mock-commander {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(to bottom, #3498db, #2980b9);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .mock-threat {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff6b6b, #ff8c00);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            animation: fall 8s linear infinite;
        }
        
        .mock-bullet {
            position: absolute;
            width: 16px;
            height: 30px;
            background: linear-gradient(to bottom, #00ffff, #0080ff);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
            display: none;
        }
        
        .mock-knowledge-button {
            position: absolute;
            top: 70px;
            right: 20px;
            width: 120px;
            height: 40px;
            background: linear-gradient(to bottom, #ffd700, #ffa500);
            border: 2px solid #ffd700;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            animation: pulse 2s infinite;
        }
        
        .mock-knowledge-button:hover {
            background: linear-gradient(to bottom, #ffa500, #ffd700);
            transform: scale(1.05);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #2ecc71;
        }
        
        .status-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .knowledge-records {
            position: absolute;
            top: 120px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #ffd700;
            border-radius: 5px;
            padding: 10px;
            font-size: 10px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <h1>🔍 子弹可见性和知识库功能测试</h1>
    
    <div class="test-section">
        <h2>✅ 修复说明</h2>
        
        <div class="test-result success">
            <h3>问题修复</h3>
            <p>✅ 已修复以下问题：</p>
            <ul>
                <li><strong>子弹可见性：</strong>修复了子弹visible属性设置问题</li>
                <li><strong>知识库按钮：</strong>添加了知识库按钮的触摸处理功能</li>
                <li><strong>碰撞检测：</strong>确保子弹能正确参与碰撞检测</li>
                <li><strong>知识记录：</strong>实现了知识库记录的显示功能</li>
            </ul>
        </div>
    </div>
    
    <div class="test-section">
        <h2>🧪 功能测试</h2>
        
        <div class="test-result info">
            <h3>模拟游戏场景</h3>
            <p>点击下面的按钮测试子弹可见性和知识库功能：</p>
            
            <div class="mock-game" id="mockGame">
                <div class="status-display" id="statusDisplay">
                    <div>子弹状态: <span id="bulletStatus">未发射</span></div>
                    <div>子弹可见: <span id="bulletVisible">false</span></div>
                    <div>知识记录: <span id="knowledgeCount">0</span></div>
                </div>
                
                <div class="mock-threat" id="mockThreat" style="left: 280px;">威胁</div>
                <div class="mock-bullet" id="mockBullet" style="left: 292px; bottom: 60px;"></div>
                <div class="mock-commander">指挥官</div>
                
                <div class="mock-knowledge-button" onclick="showKnowledgeBase()">📚 知识库</div>
                <div class="knowledge-records" id="knowledgeRecords">
                    <h4>知识库记录</h4>
                    <div id="recordsList"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="testBulletVisibility()">测试子弹可见性</button>
                <button onclick="testBulletCollision()">测试子弹碰撞</button>
                <button onclick="testKnowledgeRecords()">测试知识记录</button>
                <button onclick="resetTest()">重置测试</button>
            </div>
        </div>
        
        <div class="test-result info">
            <h3>修复详情</h3>
            <div style="font-family: monospace; font-size: 12px; background: rgba(0, 0, 0, 0.9); padding: 15px; border-radius: 5px;">
                <strong>1. 子弹可见性修复：</strong><br>
                - 在子弹初始化时设置 this.visible = true<br>
                - 在render方法中检查 visible 属性<br>
                - 确保子弹能正确显示和参与碰撞检测<br><br>
                
                <strong>2. 知识库按钮功能：</strong><br>
                - 添加了知识库按钮的触摸处理<br>
                - 实现了 showKnowledgeBase() 方法<br>
                - 显示知识库记录和详细信息<br><br>
                
                <strong>3. 碰撞检测优化：</strong><br>
                - 确保子弹的 visible 和 isActive 属性正确<br>
                - 修复了碰撞检测失败的问题<br>
                - 添加了详细的调试信息<br><br>
                
                <strong>4. 知识记录系统：</strong><br>
                - 实现了知识库记录的显示<br>
                - 支持错误记录和成功记录<br>
                - 提供详细的时间戳和类型信息
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>📋 代码修改详情</h2>
        
        <div class="test-result info">
            <h3>1. js/player/bullet.js 修改</h3>
            <pre><code>// 修复子弹可见性
init(x, y, type = 'normal') {
  this.x = x;
  this.y = y;
  this.type = type;
  this.isActive = true;
  this.visible = true; // 确保子弹可见
  this.trail = [];
  
  this.setupBulletType();
  console.log(`💥 子弹初始化: 位置(${x}, ${y}), 类型: ${type}, 可见: ${this.visible}`);
}

// 修复渲染方法
render(ctx) {
  if (!this.isActive || !this.visible) return; // 检查可见性
  // ... 渲染逻辑
}</code></pre>
        </div>
        
        <div class="test-result info">
            <h3>2. js/runtime/gameinfo.js 修改</h3>
            <pre><code>// 添加知识库按钮触摸处理
handleTouch(x, y) {
  // 检查知识库按钮
  if (this.showKnowledgeButton) {
    const knowledgeButtonWidth = 120;
    const knowledgeButtonHeight = 40;
    const knowledgeButtonX = SCREEN_WIDTH - knowledgeButtonWidth - 20;
    const knowledgeButtonY = 70;

    if (x >= knowledgeButtonX && x <= knowledgeButtonX + knowledgeButtonWidth &&
        y >= knowledgeButtonY && y <= knowledgeButtonY + knowledgeButtonHeight) {
      console.log('📚 点击了知识库按钮');
      this.showKnowledgeBase();
      return;
    }
  }
  // ... 其他触摸处理
}

// 添加知识库显示方法
showKnowledgeBase() {
  console.log('📚 显示知识库');
  
  if (GameGlobal.databus && GameGlobal.databus.knowledgeRecords) {
    const records = GameGlobal.databus.knowledgeRecords;
    console.log(`📖 知识库记录数量: ${records.length}`);
    
    records.forEach((record, index) => {
      console.log(`📝 记录 ${index + 1}:`);
      console.log(`   时间: ${record.timestamp}`);
      console.log(`   类型: ${record.type}`);
      console.log(`   内容: ${record.point}`);
    });
  }
  
  this.emit('showKnowledgeBase');
}</code></pre>
        </div>
    </div>

    <script>
        let bulletVisible = false;
        let knowledgeRecords = [];
        let isShooting = false;
        
        function testBulletVisibility() {
            console.log('🔍 测试子弹可见性');
            
            const bullet = document.getElementById('mockBullet');
            bullet.style.display = 'block';
            bulletVisible = true;
            
            document.getElementById('bulletStatus').textContent = '已发射';
            document.getElementById('bulletVisible').textContent = 'true';
            
            // 模拟子弹移动
            let bulletY = 60;
            const animation = setInterval(() => {
                bulletY += 5;
                bullet.style.bottom = bulletY + 'px';
                
                if (bulletY >= 200) {
                    clearInterval(animation);
                    bullet.style.display = 'none';
                    bullet.style.bottom = '60px';
                    bulletVisible = false;
                    
                    document.getElementById('bulletStatus').textContent = '已销毁';
                    document.getElementById('bulletVisible').textContent = 'false';
                    
                    console.log('💥 子弹碰撞测试完成');
                }
            }, 50);
            
            showResult('success', '子弹可见性测试完成');
        }
        
        function testBulletCollision() {
            console.log('💥 测试子弹碰撞检测');
            
            // 模拟碰撞检测
            const bulletX = 292;
            const bulletY = 200;
            const threatX = 280;
            const threatY = 200;
            
            const distance = Math.sqrt(
                Math.pow(bulletX - threatX, 2) + 
                Math.pow(bulletY - threatY, 2)
            );
            
            console.log(`📏 子弹位置: (${bulletX}, ${bulletY})`);
            console.log(`📏 威胁位置: (${threatX}, ${threatY})`);
            console.log(`📏 距离: ${distance.toFixed(2)}`);
            
            if (distance < 50) {
                console.log('✅ 碰撞检测成功！');
                showResult('success', '碰撞检测成功，距离: ' + distance.toFixed(2));
            } else {
                console.log('❌ 碰撞检测失败，距离过远');
                showResult('warning', '碰撞检测失败，距离: ' + distance.toFixed(2));
            }
        }
        
        function testKnowledgeRecords() {
            console.log('📚 测试知识记录');
            
            // 添加一些测试记录
            const testRecords = [
                {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    type: 'success',
                    point: '成功使用防火墙防御钓鱼攻击'
                },
                {
                    id: Date.now() + 1,
                    timestamp: new Date().toLocaleString(),
                    type: 'error',
                    point: '错误使用加密师防御恶意软件',
                    threatName: '恶意软件',
                    wrongDefense: '加密师',
                    correctDefense: '检测者'
                }
            ];
            
            knowledgeRecords = testRecords;
            document.getElementById('knowledgeCount').textContent = knowledgeRecords.length;
            
            console.log(`📖 添加了 ${knowledgeRecords.length} 条知识记录`);
            showResult('success', `添加了 ${knowledgeRecords.length} 条知识记录`);
        }
        
        function showKnowledgeBase() {
            console.log('📚 显示知识库');
            
            const recordsDiv = document.getElementById('knowledgeRecords');
            const recordsList = document.getElementById('recordsList');
            
            if (knowledgeRecords.length === 0) {
                recordsList.innerHTML = '<p>暂无知识记录</p>';
            } else {
                let html = '';
                knowledgeRecords.forEach((record, index) => {
                    html += `<div style="margin-bottom: 10px; padding: 5px; border-left: 3px solid ${record.type === 'success' ? '#00ff00' : '#ff0000'};">`;
                    html += `<strong>记录 ${index + 1}</strong><br>`;
                    html += `时间: ${record.timestamp}<br>`;
                    html += `类型: ${record.type === 'success' ? '成功' : '错误'}<br>`;
                    html += `内容: ${record.point}<br>`;
                    
                    if (record.type === 'error') {
                        html += `威胁: ${record.threatName}<br>`;
                        html += `错误防御: ${record.wrongDefense}<br>`;
                        html += `正确防御: ${record.correctDefense}<br>`;
                    }
                    html += '</div>';
                });
                recordsList.innerHTML = html;
            }
            
            recordsDiv.style.display = recordsDiv.style.display === 'none' ? 'block' : 'none';
        }
        
        function resetTest() {
            bulletVisible = false;
            knowledgeRecords = [];
            isShooting = false;
            
            // 重置显示
            document.getElementById('bulletStatus').textContent = '未发射';
            document.getElementById('bulletVisible').textContent = 'false';
            document.getElementById('knowledgeCount').textContent = '0';
            document.getElementById('knowledgeRecords').style.display = 'none';
            
            // 重置子弹
            const bullet = document.getElementById('mockBullet');
            bullet.style.display = 'none';
            bullet.style.bottom = '60px';
            
            showResult('info', '测试已重置');
        }
        
        function showResult(type, message) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<h4>${message}</h4>`;
            
            document.querySelector('.test-section:nth-child(2)').appendChild(resultDiv);
            
            setTimeout(() => {
                resultDiv.remove();
            }, 3000);
        }
        
        // 页面加载完成后的初始化
        window.addEventListener('load', function() {
            console.log('🔍 子弹可见性和知识库功能测试页面加载完成');
            console.log('✅ 子弹可见性和知识库功能已修复');
        });
    </script>
</body>
</html> 